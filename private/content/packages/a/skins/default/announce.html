<!DOCTYPE html>
<html lang="ru">
  <%include inc/head.html%>
  <%include inc/style.html%>
  <body>

    <!-- Fixed navbar -->
    <%include inc/menu.html%>
    
    <div class="container" style="padding-top:20px;">
        <div class="blog-header">
          <h3 class="blog-title">Анонсы "<%$i.name%>"</h3>
          <p><span class="glyphicon glyphicon-leaf"></span> &raquo; <%$i.t_path%> &raquo; <%$i.t_item%></p>
          <hr>
        </div>
        <table width="100%">
          <tr>
            <td class="issue_table_header" width="50%">Название</td>
            <td class="issue_table_header" width="20%">Дата</td>
            <td class="issue_table_header" width="10%">Раздел</td>
            <td class="issue_table_header" width="10%">Подраздел</td>
            <td class="issue_table_header" width="5%"><a class="" data-toggle="modal"
              data-target="#addAnn" id="addAnnButton" style="cursor:pointer;"><span 
              class="glyphicon glyphicon-file" aria-hidden="true"></span></a></td>
          </tr>
          <%loop $anns as $i%>
          <tr>
            <td class="issue_table" width="50%"><a class="editAnnButton" data-toggle="modal"
              data-target="#addAnn" style="cursor:pointer;" aname="<%$i.name%>"
              aid="<%$i.aid%>" abody="<%$i.body%>" path="<%$i.path%>" item="<%$i.item%>" ctime="<%$i.ctime%>"><%$i.name%></a></td>
            <td class="issue_table" width="20%"><%$i.create_time%></td>
            <td class="issue_table" width="10%"><%$i.t_path%></td>
            <td class="issue_table" width="10%"><%$i.t_item%></td>
            <td class="issue_table" width="5%"><a class="deleteAnnounce" aname="<%$i.name%>" aid="<%$i.aid%>" style="cursor:pointer;"><span 
              class="glyphicon glyphicon-remove-sign"></span></a></td>
          </tr>
          <%/loop%>
        </table>
      </div>

    <%include inc/footer.html%>
    <!-- Модаль -->
    <div class="modal fade" id="addAnn" tabindex="-1" role="dialog" aria-labelledby="ddTopicLabel">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
              <h4 class="modal-title" id="myModalLabel">Добавить анонс</h4>
            </div>
            <div class="modal-body">
              <p><input type="text" id="aName" name="aName" class="form-control" value="" placeholder="Название анонса" required autofocus></p>
              <p><textarea class="form-control" placeholder="Текст анонса" id="aBody" style="height: 250px;"></textarea></p>
              <p>
                <select class="form-control" name="bBranche" id="branche">
                </select>
              </p>
              <p>
                <select class="form-control" name="bsBranche" id="sbranche" disabled>
                </select>
              </p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal" id="closeDialog">Закрыть</button>
              <button type="button" class="btn btn-primary" id="doTopic" style="display: none;">Добавить</button>
              <button type="button" class="btn btn-primary" id="doSaveTopic" style="display: none;">Сохранить</button>
            </div>
          </div>
        </div>
      </div>
    
    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/js/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="/js/jquery.min.js"><\/script>')</script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/jquery.json.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="/js/ie10-viewport-bug-workaround.js"></script>
    <script type="text/javascript">
      var sStructure = {};
      var issue_id = '<%$i.issue_id%>';

      $('.deleteAnnounce').click(function(){
        var aname = $(this).attr('aname');
        var aid = $(this).attr('aid');
        if(confirm('Удалить "' + aname + '"?')) {
          $.post(
          '/cgi-bin/index.cgi', {
            pkg: 'content:a',
            action: 'delete_announce',
            aName: aname,
            aid: aid,
            issue_id: issue_id
          },
          function(data, textStatus){
            if(!data || !$.evalJSON(data)) {
              alert('Error!');
            }
            if ($.evalJSON(data).error == 1) {
              alert('Ошибка!');
            } else {
              // alert($.evalJSON(data).issue_id);
              window.location.href = '/cgi-bin/index.cgi?pkg=content:a&action=announce&issue_id=' + issue_id;
            }
          }
        );

        }
      });

      $('#doTopic').click(function(){
        if(!$('#aName').val() || !$('#branche').val() || !$('#aBody').val()) { alert('Заполните все поля!'); return; }
        $.post(
          '/cgi-bin/index.cgi', {
            pkg: 'content:a',
            action: 'create_announce',
            aName: $('#aName').val(),
            aBody: $('#aBody').val(),
            sbranche: $('#sbranche').val(),
            branche: $('#branche').val(),
            issue_id: issue_id
          },
          function(data, textStatus){
            if(!data || !$.evalJSON(data)) {
              alert('Error!');
            }
            if ($.evalJSON(data).error == 1) {
              alert('Статья с таким именем уже есть!');
            } else {
              // alert($.evalJSON(data).issue_id);
              window.location.href = '/cgi-bin/index.cgi?pkg=content:a&action=announce&issue_id=' + issue_id;
            }
          }
        );
      });

      $('.editAnnButton').click(function(){
        var aname = $(this).attr('aname');
        var aid = $(this).attr('aid');
        var abody = $(this).attr('abody');
        var path = $(this).attr('path');
        var item = $(this).attr('item');
        var ctime = $(this).attr('ctime');
        $('#sbranche').attr('disabled', 'disabled');
        $('#sbranche').empty();
        $('#aName').val(aname);
        $('#aBody').val(abody);
        $('#doTopic').css('display', 'none');
        $('#doSaveTopic').css('display', 'inline');
        $('#doSaveTopic').unbind('click');
        $('#doSaveTopic').click(function(){
          if(!$('#aName').val() || !$('#branche').val() || !$('#aBody').val()) { alert('Заполните все поля!'); return; }
          $.post(
            '/cgi-bin/index.cgi', {
              pkg: 'content:a',
              action: 'save_announce',
              aName: $('#aName').val(),
              aBody: $('#aBody').val(),
              sbranche: $('#sbranche').val(),
              branche: $('#branche').val(),
              issue_id: issue_id,
              aid: aid,
              ctime: ctime
            },
            function(data, textStatus){
              if(!data || !$.evalJSON(data)) {
                alert('Error!');
              }
              if ($.evalJSON(data).error == 1) {
                alert('Ошибка!');
              } else {
                // alert($.evalJSON(data).issue_id);
                window.location.href = '/cgi-bin/index.cgi?pkg=content:a&action=announce&issue_id=' + issue_id;
              }
            }
          );          
        });
        $('#myModalLabel').html('Редактирование');
        loadStructure(path, item);
      });

      $('#addAnnButton').click(function(){
        $('#sbranche').attr('disabled', 'disabled');
        $('#sbranche').empty();
        $('#aName').val('');
        $('#aBody').val('');
        $('#myModalLabel').html('Добавить анонс');
        $('#doTopic').css('display', 'inline');
        $('#doSaveTopic').css('display', 'none');
        loadStructure();
      });
    
      $('#branche').change(function(){
        var path = $('#branche').val();
        $('#sbranche').attr('disabled', 'disabled');
        $('#sbranche').empty();
        if(!path) { return; }
        if(sStructure[$('#branche').val()].items) {
          $("#sbranche").append('<option value="">Подраздел</option>');
          for (var i = 1; i < 100; i++) {
            var existTopic = false;
            for (var topic in sStructure[path].items) {
              if(sStructure[path].items[topic].sort_id == i) {
                $("#sbranche").append('<option value="' + topic +'">' + sStructure[path].items[topic].name + '</option>');
                existTopic = true;
              }
            }
            if(!existTopic) break;
          }
          $('#sbranche').removeAttr('disabled');
        }
      });

      function showBranche() {
        $('#branche').empty();
        $("#branche").append('<option value="" selected>Раздел</option>');
        $("#branche").append('<option value="__main">Главный анонс</option>');
        $("#branche").append('<option value="__main_lenta">Главная лента анонсов</option>');
        for (var i = 1; i < 100; i++) {
          var existTopic = false;
          for (var topic in sStructure) {
            if(sStructure[topic].sort_id == i) {
              $("#branche").append('<option value="' + topic +'">' + sStructure[topic].name + '</option>');
              existTopic = true;
            }
          }
          if(!existTopic) break;
        }
      }

      function loadStructure(path, item) {
        $.post(
          '/cgi-bin/index.cgi', {
            pkg: 'content:a',
            action: 'load_structure'
          },
          function(data, textStatus){
            if(!data || !$.evalJSON(data)) {
              alert('Error!');
            } else {
              sStructure = $.evalJSON(data);
              showBranche();
              if(path) {
                $('#branche').val(path);
                if(item) {
                  if(sStructure[$('#branche').val()].items) {
                    $("#sbranche").append('<option value="">Подраздел</option>');
                    for (var i = 1; i < 100; i++) {
                      var existTopic = false;
                      for (var topic in sStructure[path].items) {
                        if(sStructure[path].items[topic].sort_id == i) {
                          $("#sbranche").append('<option value="' + topic +'">' + sStructure[path].items[topic].name + '</option>');
                          existTopic = true;
                        }
                      }
                      if(!existTopic) break;
                    }
                    $('#sbranche').removeAttr('disabled');
                  }
                  $('#sbranche').val(item);
                }
              }        
            }
          }
        );
      }

    </script>
  </body>
</html>
